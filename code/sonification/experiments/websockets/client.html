<html>
<meta charset="UTF-8">
<head>
<title>Websockets Experiments</title>
</head>
<style>
  #post {
    text-align: left;
    font-family: monospace;
    font-size: 20px;
    max-width: 800px;
  }

</style>
<body>

<div id="post"></div>

<script>
// simple websockets connection
var ws;
var postwindow = document.getElementById("post");
var post = function (str) {
  console.log(str);
  postwindow.innerHTML = postwindow.innerHTML + "<br/>\n" + str;
};
var init = function () {
  ws = new WebSocket('ws://127.0.0.1:8080/interface');

  ws.onopen = function() {
    post('Connected')
    post('Protocol:' + ws.protocol);
    //conn.binaryType = 'arraybuffer';
    var oscmsg = {address: "/browser/status",
    args: [
      {type: "s", value: "Hello from the browser"},
      {type: "i", value: 57120},
      {type: "f", value: 42.24},
    ]};
    post("Sending: " + oscmsg);
    ws.send(JSON.stringify(oscmsg));
  };
  ws.onmessage = function(evt) {
    var str = evt.data; // messages must be valid json
    var msg = JSON.parse(str);
    var it=1;
    // No OSC parsing here, for now we just send data to the server
    for (const key of Object.keys(msg)) {
      if(it==1) {
        post("received/\t" + key + ": " + msg[key]);
        it=0;
      } else {
        post("\t\t" + key + ": " + msg[key]);
      }
    }
    if(it==1) { post("received/\t" + "EMPTY") }
  };
  ws.onclose = function() { post('Connection closed...') };
};

if(!("WebSocket" in window)) {
    alert("Your browser does not support web sockets");
} else {
    init();
}
</script>

</body>
</html>
