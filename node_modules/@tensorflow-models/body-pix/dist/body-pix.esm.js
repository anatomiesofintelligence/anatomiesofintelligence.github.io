// @tensorflow/tfjs-models Copyright 2019 Google
import*as tf from"@tensorflow/tfjs";import{tidy,util,loadGraphModel,oneHot,scalar,range,Tensor,browser,pad3d,slice3d,div,sub}from"@tensorflow/tfjs";function __awaiter(e,t,r,n){return new(r||(r=Promise))(function(a,o){function i(e){try{d(n.next(e))}catch(e){o(e)}}function s(e){try{d(n.throw(e))}catch(e){o(e)}}function d(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(i,s)}d((n=n.apply(e,t||[])).next())})}function __generator(e,t){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===o[0]||2===o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var mobileNet100Architecture=[["conv2d",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",2],["separableConv",1]],mobileNet75Architecture=[["conv2d",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1]],mobileNet50Architecture=[["conv2d",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1]],mobileNet25Architecture=mobileNet50Architecture,VALID_OUTPUT_STRIDES=[8,16,32];function assertValidOutputStride(e){util.assert("number"==typeof e,function(){return"outputStride is not a number"}),util.assert(VALID_OUTPUT_STRIDES.indexOf(e)>=0,function(){return"outputStride of "+e+" is invalid. It must be either 8, 16, or 32"})}var mobileNetArchitectures={100:mobileNet100Architecture,75:mobileNet75Architecture,50:mobileNet50Architecture,25:mobileNet25Architecture};function toOutputStridedLayers(e,t){var r=1,n=1;return e.map(function(e,a){var o,i,s=e[0],d=e[1];return r===t?(o=1,i=n,n*=d):(o=d,i=1,r*=d),{blockId:a,convType:s,stride:o,rate:i,outputStride:r}})}var MobileNet=function(){function e(e,t){this.PREPROCESS_DIVISOR=scalar(127.5),this.ONE=scalar(1),this.modelWeights=e,this.convolutionDefinitions=t}return e.prototype.predict=function(e,t){var r=this,n=div(e.toFloat(),this.PREPROCESS_DIVISOR),a=sub(n,this.ONE);return toOutputStridedLayers(this.convolutionDefinitions,t).reduce(function(e,t){var n=t.blockId,a=t.stride,o=t.convType,i=t.rate;if("conv2d"===o)return r.conv(e,a,n);if("separableConv"===o)return r.separableConv(e,a,n,i);throw Error("Unknown conv type of "+o)},a)},e.prototype.convToOutput=function(e,t){return e.conv2d(this.weights(t),1,"same").add(this.convBias(t,!1))},e.prototype.conv=function(e,t,r){var n=this.weights("Conv2d_"+String(r));return e.conv2d(n,t,"same").add(this.convBias("Conv2d_"+String(r))).clipByValue(0,6)},e.prototype.separableConv=function(e,t,r,n){void 0===n&&(n=1);var a="Conv2d_"+String(r)+"_depthwise",o="Conv2d_"+String(r)+"_pointwise";return e.depthwiseConv2D(this.depthwiseWeights(a),t,"same","NHWC",n).add(this.depthwiseBias(a)).clipByValue(0,6).conv2d(this.weights(o),[1,1],"same").add(this.convBias(o)).clipByValue(0,6)},e.prototype.weights=function(e){return this.modelWeights.weights(e)},e.prototype.convBias=function(e,t){return void 0===t&&(t=!0),this.modelWeights.convBias(e,t)},e.prototype.depthwiseBias=function(e){return this.modelWeights.depthwiseBias(e)},e.prototype.depthwiseWeights=function(e){return this.modelWeights.depthwiseWeights(e)},e.prototype.dispose=function(){this.modelWeights.dispose()},e}(),BASE_URL="https://storage.googleapis.com/tfjs-models/savedmodel/",checkpoints={1:{url:BASE_URL+"posenet_mobilenet_100_partmap/",architecture:mobileNetArchitectures[100]},.75:{url:BASE_URL+"posenet_mobilenet_075_partmap/",architecture:mobileNetArchitectures[75]},.5:{url:BASE_URL+"posenet_mobilenet_050_partmap/",architecture:mobileNetArchitectures[50]},.25:{url:BASE_URL+"posenet_mobilenet_025_partmap/",architecture:mobileNetArchitectures[25]}};function toFlattenedOneHotPartMap(e){var t=e.shape[2],r=e.argMax(2).reshape([-1]);return oneHot(r,t)}function clipByMask2d(e,t){return e.mul(t)}function toMask(e,t){return tidy(function(){return e.greater(scalar(t)).toInt()})}function decodePartSegmentation(e,t){var r=t.shape,n=r[0],a=r[1],o=r[2];return tidy(function(){var r=toFlattenedOneHotPartMap(t),i=range(0,o,1,"int32").expandDims(1);return clipByMask2d(r.matMul(i).toInt().reshape([n,a]).add(scalar(1,"int32")),e).sub(scalar(1,"int32"))})}var ModelWeights=function(){function e(e){this.graphModel=e}return e.prototype.weights=function(e){return this.getVariable("MobilenetV1/"+e+"/weights")},e.prototype.convBias=function(e,t){return void 0===t&&(t=!0),this.getVariable("MobilenetV1/"+e+"/Conv2D_bias")},e.prototype.depthwiseBias=function(e){return this.getVariable("MobilenetV1/"+e+"/depthwise_bias")},e.prototype.depthwiseWeights=function(e){return this.getVariable("MobilenetV1/"+e+"/depthwise_weights")},e.prototype.getVariable=function(e){return this.graphModel.weights[""+e][0]},e.prototype.dispose=function(){this.graphModel.dispose()},e}();function getInputTensorDimensions(e){return e instanceof Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}function toInputTensor(e){return e instanceof Tensor?e:browser.fromPixels(e)}function resizeAndPadTo(e,t,r){var n=t[0],a=t[1];void 0===r&&(r=!1);var o,i,s,d,u,l,c=getInputTensorDimensions(e),p=c[0],h=c[1]/p;if(h>a/n){o=a;var f=n-(i=Math.ceil(o/h));s=0,d=0,u=Math.floor(f/2),l=n-(i+u)}else{i=n;var v=a-(o=Math.ceil(n*h));s=Math.floor(v/2),d=a-(o+s),u=0,l=0}return{resizedAndPadded:tidy(function(){var t,n=toInputTensor(e);return t=r?n.reverse(1).resizeBilinear([i,o]):n.resizeBilinear([i,o]),pad3d(t,[[u,l],[s,d],[0,0]])}),paddedBy:[[u,l],[s,d]]}}function scaleAndCropToInputTensorShape(e,t,r,n){var a=t[0],o=t[1],i=r[0],s=r[1],d=n[0],u=d[0],l=d[1],c=n[1],p=c[0],h=c[1];return tidy(function(){return removePaddingAndResizeBack(e.resizeBilinear([i,s],!0),[a,o],[[u,l],[p,h]])})}function removePaddingAndResizeBack(e,t,r){var n=t[0],a=t[1],o=r[0],i=o[0],s=o[1],d=r[1],u=d[0],l=d[1],c=e.shape,p=c[0],h=c[1],f=p-(i+s),v=h-(u+l);return tidy(function(){return slice3d(e,[i,u,0],[f,v,e.shape[2]]).resizeBilinear([n,a],!0)})}var _this=void 0,segmentationModelImageDimensions=[353,257],BodyPix=function(){function e(e){this.mobileNet=e}return e.prototype.predictForSegmentation=function(e,t){var r=this;return void 0===t&&(t=16),assertValidOutputStride(t),tidy(function(){var n=r.mobileNet.predict(e,t);return r.mobileNet.convToOutput(n,"segment_2").sigmoid()})},e.prototype.predictForPartMap=function(e,t){var r=this;return void 0===t&&(t=16),assertValidOutputStride(t),tidy(function(){var n=r.mobileNet.predict(e,t),a=r.mobileNet.convToOutput(n,"segment_2"),o=r.mobileNet.convToOutput(n,"part_heatmap_2");return{segmentScores:a.sigmoid(),partHeatmapScores:o.sigmoid()}})},e.prototype.estimatePersonSegmentation=function(e,t,r){return void 0===t&&(t=16),void 0===r&&(r=.5),__awaiter(this,void 0,void 0,function(){var n,a,o,i,s,d=this;return __generator(this,function(u){switch(u.label){case 0:return assertValidOutputStride(t),n=getInputTensorDimensions(e),a=n[0],o=n[1],[4,(i=tidy(function(){var n=resizeAndPadTo(e,segmentationModelImageDimensions),i=n.resizedAndPadded,s=n.paddedBy,u=d.predictForSegmentation(i,t),l=i.shape,c=l[0],p=l[1];return toMask(scaleAndCropToInputTensorShape(u,[a,o],[c,p],s).squeeze(),r)})).data()];case 1:return s=u.sent(),i.dispose(),[2,{height:a,width:o,data:s}]}})})},e.prototype.estimatePartSegmentation=function(e,t,r){return void 0===t&&(t=16),void 0===r&&(r=.5),__awaiter(this,void 0,void 0,function(){var n,a,o,i,s,d=this;return __generator(this,function(u){switch(u.label){case 0:return assertValidOutputStride(t),n=getInputTensorDimensions(e),a=n[0],o=n[1],[4,(i=tidy(function(){var n=resizeAndPadTo(e,segmentationModelImageDimensions),i=n.resizedAndPadded,s=n.paddedBy,u=d.predictForPartMap(i,t),l=u.segmentScores,c=u.partHeatmapScores,p=i.shape,h=p[0],f=p[1],v=scaleAndCropToInputTensorShape(l,[a,o],[h,f],s),g=scaleAndCropToInputTensorShape(c,[a,o],[h,f],s);return decodePartSegmentation(toMask(v.squeeze(),r),g)})).data()];case 1:return s=u.sent(),i.dispose(),[2,{height:a,width:o,data:s}]}})})},e.prototype.dispose=function(){this.mobileNet.dispose()},e}();function load(e){return void 0===e&&(e=.75),__awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(n){switch(n.label){case 0:if(null==tf)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this model.");return t=Object.keys(checkpoints),util.assert("number"==typeof e,function(){return"got multiplier type of "+typeof e+" when it should be a number."}),util.assert(t.indexOf(e.toString())>=0,function(){return"invalid multiplier value of "+e+".  No checkpoint exists for that multiplier. Must be one of "+t.join(",")+"."}),[4,mobilenetLoader.load(e)];case 1:return r=n.sent(),[2,new BodyPix(r)]}})})}var mobilenetLoader={load:function(e){return __awaiter(_this,void 0,void 0,function(){var t,r,n,a;return __generator(this,function(o){switch(o.label){case 0:return t=checkpoints[e],r=t.url,[4,loadGraphModel(r+"model.json")];case 1:return n=o.sent(),a=new ModelWeights(n),[2,new MobileNet(a,t.architecture)]}})})}};function cpuBlur(e,t,r){for(var n=e.getContext("2d"),a=0,o=1/(2*Math.PI*5*5),i=r<3?1:2,s=-r;s<=r;s+=i)for(var d=-r;d<=r;d+=i){a+=o*Math.exp(-(d*d+s*s)/50)}for(s=-r;s<=r;s+=i)for(d=-r;d<=r;d+=i)n.globalAlpha=o*Math.exp(-(d*d+s*s)/50)/a*r,n.drawImage(t,d,s);n.globalAlpha=1}var offScreenCanvases={};function isSafari(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function assertSameDimensions(e,t,r,n){var a=e.width,o=e.height,i=t.width,s=t.height;if(a!==i||o!==s)throw new Error("error: dimensions must match. "+r+" has dimensions "+a+"x"+o+", "+n+" has dimensions "+i+"x"+s)}function flipCanvasHorizontal(e){var t=e.getContext("2d");t.scale(-1,1),t.translate(-e.width,0)}function drawWithCompositing(e,t,r){e.globalCompositeOperation=r,e.drawImage(t,0,0)}function createOffScreenCanvas(){return document.createElement("canvas")}function ensureOffscreenCanvasCreated(e){return offScreenCanvases[e]||(offScreenCanvases[e]=createOffScreenCanvas()),offScreenCanvases[e]}function drawAndBlurImageOnCanvas(e,t,r){var n=e.height,a=e.width,o=r.getContext("2d");r.width=a,r.height=n,o.clearRect(0,0,a,n),o.save(),isSafari()?cpuBlur(r,e,t):(o.filter="blur("+t+"px)",o.drawImage(e,0,0,a,n)),o.restore()}function drawAndBlurImageOnOffScreenCanvas(e,t,r){var n=ensureOffscreenCanvasCreated(r);return 0===t?renderImageToCanvas(e,n):drawAndBlurImageOnCanvas(e,t,n),n}function renderImageToCanvas(e,t){var r=e.width,n=e.height;t.width=r,t.height=n,t.getContext("2d").drawImage(e,0,0,r,n)}function renderImageDataToCanvas(e,t){t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0)}function renderImageDataToOffScreenCanvas(e,t){var r=ensureOffscreenCanvasCreated(t);return renderImageDataToCanvas(e,r),r}function toMaskImageData(e,t){void 0===t&&(t=!0);for(var r=e.width,n=e.height,a=e.data,o=new Uint8ClampedArray(r*n*4),i=0;i<n*r;++i){var s=255*(t?1-a[i]:a[i]),d=4*i;o[d+0]=0,o[d+1]=0,o[d+2]=0,o[d+3]=Math.round(s)}return new ImageData(o,r,n)}function toColoredPartImageData(e,t){for(var r=e.width,n=e.height,a=e.data,o=new Uint8ClampedArray(r*n*4),i=0;i<n*r;++i){var s=Math.round(a[i]),d=4*i;if(-1===s)o[d+0]=255,o[d+1]=255,o[d+2]=255,o[d+3]=255;else{var u=t[s];if(!u)throw new Error("No color could be found for part id "+s);o[d+0]=u[0],o[d+1]=u[1],o[d+2]=u[2],o[d+3]=255}}return new ImageData(o,r,n)}var CANVAS_NAMES={blurred:"blurred",blurredMask:"blurred-mask",mask:"mask",lowresPartMask:"lowres-part-mask"};function drawMask(e,t,r,n,a,o){void 0===n&&(n=.7),void 0===a&&(a=0),void 0===o&&(o=!1),assertSameDimensions(t,r,"image","mask");var i=drawAndBlurImageOnOffScreenCanvas(renderImageDataToOffScreenCanvas(r,CANVAS_NAMES.mask),a,CANVAS_NAMES.blurredMask);e.width=i.width,e.height=i.height;var s=e.getContext("2d");s.save(),o&&flipCanvasHorizontal(e),s.drawImage(t,0,0),s.globalAlpha=n,s.drawImage(i,0,0),s.restore()}function drawPixelatedMask(e,t,r,n,a,o,i){void 0===n&&(n=.7),void 0===a&&(a=0),void 0===o&&(o=!1),void 0===i&&(i=10),assertSameDimensions(t,r,"image","mask");var s=drawAndBlurImageOnOffScreenCanvas(renderImageDataToOffScreenCanvas(r,CANVAS_NAMES.mask),a,CANVAS_NAMES.blurredMask);e.width=s.width,e.height=s.height;var d=e.getContext("2d");d.save(),o&&flipCanvasHorizontal(e);var u=ensureOffscreenCanvasCreated(CANVAS_NAMES.lowresPartMask),l=u.getContext("2d");u.width=s.width*(1/i),u.height=s.height*(1/i),l.drawImage(s,0,0,s.width,s.height,0,0,u.width,u.height),d.imageSmoothingEnabled=!1,d.drawImage(u,0,0,u.width,u.height,0,0,e.width,e.height);for(var c=0;c<u.width;c++)d.beginPath(),d.strokeStyle="#ffffff",d.moveTo(i*c,0),d.lineTo(i*c,e.height),d.stroke();for(c=0;c<u.height;c++)d.beginPath(),d.strokeStyle="#ffffff",d.moveTo(0,i*c),d.lineTo(e.width,i*c),d.stroke();d.globalAlpha=1-n,d.drawImage(t,0,0),d.restore()}function createPersonMask(e,t){var r=renderImageDataToOffScreenCanvas(toMaskImageData(e,!1),CANVAS_NAMES.mask);return 0===t?r:drawAndBlurImageOnOffScreenCanvas(r,t,CANVAS_NAMES.blurredMask)}function drawBokehEffect(e,t,r,n,a,o){void 0===n&&(n=3),void 0===a&&(a=3),void 0===o&&(o=!1),assertSameDimensions(t,r,"image","segmentation");var i=drawAndBlurImageOnOffScreenCanvas(t,n,CANVAS_NAMES.blurred),s=createPersonMask(r,a),d=e.getContext("2d");d.save(),o&&flipCanvasHorizontal(e),d.drawImage(t,0,0),drawWithCompositing(d,s,"destination-in"),drawWithCompositing(d,i,"destination-over"),d.restore()}var partChannels=["leftFace","rightFace","rightUpperLegFront","rightLowerLegBack","rightUpperLegBack","leftLowerLegFront","leftUpperLegFront","leftUpperLegBack","leftLowerLegBack","rightFeet","rightLowerLegFront","leftFeet","torsoFront","torsoBack","rightUpperArmFront","rightUpperArmBack","rightLowerArmBack","leftLowerArmFront","leftUpperArmFront","leftUpperArmBack","leftLowerArmBack","rightHand","rightLowerArmFront","leftHand"];export{BodyPix,load,checkpoints,decodePartSegmentation,toMask,drawBokehEffect,drawMask,drawPixelatedMask,toColoredPartImageData,toMaskImageData,partChannels,resizeAndPadTo,scaleAndCropToInputTensorShape};
